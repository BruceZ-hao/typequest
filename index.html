<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeQuest - å•è¯å†’é™©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Compat CDNï¼ˆå¯é€‰ï¼Œæ— ç½‘ç»œæ—¶è‡ªåŠ¨é™çº§ï¼‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;700;900&display=swap');

        body {
            font-family: 'JetBrains Mono', 'Noto Sans SC', monospace;
            background: #0a0a0f;
            overflow-x: hidden;
        }

        .cyber-grid {
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .scroll-container {
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }

        .word {
            display: inline-flex;
            margin-right: 2rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .word.completed {
            opacity: 0.3;
            transform: scale(0.9);
        }

        .word.current {
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(0, 217, 255, 0.5));
        }

        .char {
            display: inline-block;
            transition: all 0.1s;
            position: relative;
        }

        .char.correct {
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88;
        }

        .char.wrong {
            color: #ff4444;
            text-decoration: underline;
            text-decoration-color: #ff4444;
            animation: shake 0.2s;
        }

        .char.pending {
            color: #4b5563;
        }

        .char.cursor {
            border-bottom: 4px solid #00d9ff;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { border-bottom-color: #00d9ff; }
            51%, 100% { border-bottom-color: transparent; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .translation {
            position: absolute;
            top: -3rem;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #000;
            padding: 0.4rem 1rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 800;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
            z-index: 10;
        }

        .word.completed .translation {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .translation::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #00d9ff;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: particleFloat 0.8s ease-out forwards;
        }

        @keyframes particleFloat {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        .book-selector {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem;
            scrollbar-width: none;
        }

        .book-selector::-webkit-scrollbar {
            display: none;
        }

        .book-btn {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
        }

        .book-btn:hover {
            transform: translateY(-2px);
        }

        .book-btn.active {
            border-color: currentColor;
            box-shadow: 0 0 15px currentColor;
        }

        .progress-glow {
            box-shadow: 0 0 10px currentColor;
        }

        .float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .music-control {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .victory-overlay {
            background: radial-gradient(circle, rgba(0,217,255,0.2) 0%, transparent 70%);
        }

        .star {
            position: absolute;
            color: #ffd700;
            font-size: 2rem;
            animation: starPop 0.6s ease-out forwards;
        }

        @keyframes starPop {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }

        .leaderboard-item {
            transition: all 0.3s;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            background: rgba(0, 217, 255, 0.1);
        }

        .rank-1 { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
        .rank-2 { color: #c0c0c0; text-shadow: 0 0 10px #c0c0c0; }
        .rank-3 { color: #cd7f32; text-shadow: 0 0 10px #cd7f32; }

        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }

        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 12px 24px;
            z-index: 40;
            backdrop-filter: blur(10px);
        }

        .key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
            border: 1px solid #4b5563;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            color: #d1d5db;
            box-shadow: 0 2px 0 #111827;
            margin: 0 2px;
        }

        .difficulty-btn {
            transition: all 0.2s;
        }

        .difficulty-btn.active {
            transform: scale(1.05);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .glow-text {
            text-shadow: 0 0 20px currentColor;
        }
    </style>
</head>
<body class="min-h-screen text-gray-100 cyber-grid relative">

    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-20 left-10 w-72 h-72 bg-cyan-500/10 rounded-full blur-3xl float"></div>
        <div class="absolute bottom-20 right-10 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl float" style="animation-delay: -3s;"></div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-6 max-w-6xl">
        
        <!-- æ ‡é¢˜ -->
        <header class="text-center mb-6">
            <h1 class="text-5xl font-black mb-2 tracking-tighter">
                <span class="bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent glow-text">
                    TYPE
                </span>
                <span class="text-white">QUEST</span>
            </h1>
            <p class="text-gray-400 text-sm tracking-widest uppercase">å•è¯å†’é™© Â· å…¨çƒæ’è¡Œæ¦œ Â· è¯ä¹¦æŒ‘æˆ˜</p>
        </header>

        <!-- éš¾åº¦é€‰æ‹© -->
        <div class="mb-4">
            <div class="text-center text-gray-400 text-xs uppercase tracking-wider mb-2">éš¾åº¦é€‰æ‹©</div>
            <div class="flex justify-center gap-2">
                <button onclick="setDifficulty('easy')" class="difficulty-btn px-4 py-2 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-sm active" data-difficulty="easy">
                    ğŸŒ± ç®€å• (10è¯)
                </button>
                <button onclick="setDifficulty('normal')" class="difficulty-btn px-4 py-2 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/50 text-sm" data-difficulty="normal">
                    ğŸ”¥ æ™®é€š (20è¯)
                </button>
                <button onclick="setDifficulty('hard')" class="difficulty-btn px-4 py-2 rounded-full bg-red-500/20 text-red-400 border border-red-500/50 text-sm" data-difficulty="hard">
                    ğŸ’€ å›°éš¾ (30è¯)
                </button>
                <button onclick="setDifficulty('daily')" class="difficulty-btn px-4 py-2 rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/50 text-sm" data-difficulty="daily">
                    ğŸ“… æ¯æ—¥æŒ‘æˆ˜
                </button>
            </div>
        </div>

        <!-- è¯ä¹¦é€‰æ‹© -->
        <div class="mb-6">
            <div class="text-center text-gray-400 text-xs uppercase tracking-wider mb-2">é€‰æ‹©è¯ä¹¦</div>
            <div class="book-selector justify-center">
                <button onclick="selectBook('cet4')" class="book-btn bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 active" data-book="cet4" style="color: #60a5fa;">
                    ğŸ“˜ å››çº§æ ¸å¿ƒ
                </button>
                <button onclick="selectBook('cet6')" class="book-btn bg-purple-500/20 text-purple-400 hover:bg-purple-500/30" data-book="cet6" style="color: #c084fc;">
                    ğŸ“— å…­çº§æ ¸å¿ƒ
                </button>
                <button onclick="selectBook('ielts')" class="book-btn bg-red-500/20 text-red-400 hover:bg-red-500/30" data-book="ielts" style="color: #f87171;">
                    ğŸ“• é›…æ€é«˜é¢‘
                </button>
                <button onclick="selectBook('toefl')" class="book-btn bg-orange-500/20 text-orange-400 hover:bg-orange-500/30" data-book="toefl" style="color: #fb923c;">
                    ğŸ“™ æ‰˜ç¦æ ¸å¿ƒ
                </button>
                <button onclick="selectBook('gre')" class="book-btn bg-green-500/20 text-green-400 hover:bg-green-500/30" data-book="gre" style="color: #4ade80;">
                    ğŸ““ GRE3000
                </button>
                <button onclick="selectBook('programming')" class="book-btn bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30" data-book="programming" style="color: #22d3ee;">
                    ğŸ’» ç¼–ç¨‹æœ¯è¯­
                </button>
                <button onclick="selectBook('business')" class="book-btn bg-amber-500/20 text-amber-400 hover:bg-amber-500/30" data-book="business" style="color: #f59e0b;">
                    ğŸ’¼ å•†åŠ¡è‹±è¯­
                </button>
                <button onclick="selectBook('academic')" class="book-btn bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30" data-book="academic" style="color: #10b981;">
                    ğŸ“ å­¦æœ¯è‹±è¯­
                </button>
            </div>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="flex justify-center gap-4 mb-4 text-center flex-wrap">
            <div class="stat-card rounded-xl px-4 py-2">
                <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">WPM</div>
                <div id="wpm" class="text-2xl font-bold text-cyan-400 font-mono">0</div>
            </div>
            <div class="stat-card rounded-xl px-4 py-2">
                <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">å‡†ç¡®ç‡</div>
                <div id="accuracy" class="text-2xl font-bold text-purple-400 font-mono">100%</div>
            </div>
            <div class="stat-card rounded-xl px-4 py-2">
                <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">è¿›åº¦</div>
                <div id="progress-text" class="text-2xl font-bold text-green-400 font-mono">0/0</div>
            </div>
            <div class="stat-card rounded-xl px-4 py-2">
                <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">è¿å‡»</div>
                <div id="combo" class="text-2xl font-bold text-yellow-400 font-mono">0</div>
            </div>
            <div class="stat-card rounded-xl px-4 py-2 cursor-pointer hover:border-cyan-500 transition-all" onclick="showLeaderboard()">
                <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">æ’è¡Œæ¦œ</div>
                <div class="text-2xl">ğŸ†</div>
            </div>
            <div class="stat-card rounded-xl px-4 py-2 cursor-pointer hover:border-pink-500 transition-all" onclick="showHistory()">
                <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">å†å²</div>
                <div class="text-2xl">ğŸ“Š</div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-full h-2 mb-6 overflow-hidden">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-cyan-500 via-purple-500 to-pink-500 w-0 transition-all duration-300 progress-glow"></div>
        </div>

        <!-- æ‰“å­—åŒºåŸŸ -->
        <div class="relative bg-gray-900/80 backdrop-blur border border-gray-700 rounded-2xl p-8 mb-4 overflow-hidden shadow-2xl" style="height: 220px;">
            
            <div id="startOverlay" class="absolute inset-0 bg-gray-900/95 z-20 flex flex-col items-center justify-center cursor-pointer transition-opacity duration-300">
                <div class="text-6xl mb-3 animate-bounce">ğŸ®</div>
                <h2 class="text-2xl font-bold text-white mb-2">ç‚¹å‡»å¼€å§‹å†’é™©</h2>
                <p class="text-gray-400 text-sm">æŒ‰ç©ºæ ¼é”®æˆ–ç‚¹å‡»æ­¤å¤„å¼€å§‹</p>
                <div class="mt-4 flex gap-2 text-xs text-gray-500 flex-wrap justify-center">
                    <span class="bg-gray-800 px-3 py-1 rounded-full">ğŸµ èƒŒæ™¯éŸ³ä¹</span>
                    <span class="bg-gray-800 px-3 py-1 rounded-full">ğŸ”Š 8-bitéŸ³æ•ˆ</span>
                    <span class="bg-gray-800 px-3 py-1 rounded-full">ğŸ† å…¨çƒæ’è¡Œ</span>
                    <span class="bg-gray-800 px-3 py-1 rounded-full">ğŸ“Š æœ¬åœ°è®°å½•</span>
                </div>
            </div>

            <div class="scroll-container w-full h-full flex items-center overflow-hidden relative">
                <div id="textTrack" class="flex items-center whitespace-nowrap transition-transform duration-500 ease-out pl-[50%]">
                </div>
            </div>

            <input type="text" id="inputField" class="absolute opacity-0 top-0 left-0 w-full h-full cursor-default" autocomplete="off" autocapitalize="off" spellcheck="false">
        </div>

        <!-- å½“å‰å•è¯ä¸­æ–‡ -->
        <div class="text-center mb-6 h-16 flex items-center justify-center">
            <div id="currentTranslation" class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 opacity-0 transition-all duration-300 transform translate-y-4 font-sans">
                å‡†å¤‡å¼€å§‹...
            </div>
        </div>

        <!-- æ§åˆ¶åŒº -->
        <div class="flex justify-center gap-4 flex-wrap">
            <button onclick="resetGame()" class="group px-6 py-3 bg-gray-800 rounded-xl border border-gray-600 hover:border-cyan-500 hover:text-cyan-400 transition-all flex items-center gap-2">
                <svg class="w-5 h-5 group-hover:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                é‡æ–°å¼€å§‹
            </button>
            
            <button onclick="toggleMusic()" id="musicBtn" class="music-control px-6 py-3 bg-gray-800 rounded-xl border border-gray-600 hover:border-green-500 hover:text-green-400 transition-all flex items-center gap-2">
                <span id="musicIcon">ğŸµ</span>
                <span>éŸ³ä¹å¼€å¯</span>
            </button>
            
            <button onclick="toggleSound()" id="soundBtn" class="px-6 py-3 bg-gray-800 rounded-xl border border-gray-600 hover:border-purple-500 hover:text-purple-400 transition-all flex items-center gap-2">
                <span id="soundIcon">ğŸ”Š</span>
                <span>éŸ³æ•ˆå¼€å¯</span>
            </button>

            <button onclick="showLeaderboard()" class="px-6 py-3 bg-gray-800 rounded-xl border border-gray-600 hover:border-yellow-500 hover:text-yellow-400 transition-all flex items-center gap-2">
                <span>ğŸ†</span>
                <span>æŸ¥çœ‹æ’è¡Œ</span>
            </button>

            <button onclick="showHistory()" class="px-6 py-3 bg-gray-800 rounded-xl border border-gray-600 hover:border-pink-500 hover:text-pink-400 transition-all flex items-center gap-2">
                <span>ğŸ“Š</span>
                <span>å†å²è®°å½•</span>
            </button>
        </div>
    </div>

    <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
    <div class="keyboard-hint hidden md:flex items-center gap-4 text-gray-400 text-sm">
        <div class="flex items-center gap-1">
            <span class="key">ç©ºæ ¼</span>
            <span>å¼€å§‹/ä¸‹ä¸€è¯</span>
        </div>
        <div class="flex items-center gap-1">
            <span class="key">R</span>
            <span>é‡æ–°å¼€å§‹</span>
        </div>
        <div class="flex items-center gap-1">
            <span class="key">M</span>
            <span>éŸ³ä¹å¼€å…³</span>
        </div>
        <div class="flex items-center gap-1">
            <span class="key">S</span>
            <span>éŸ³æ•ˆå¼€å…³</span>
        </div>
        <div class="flex items-center gap-1">
            <span class="key">L</span>
            <span>æ’è¡Œæ¦œ</span>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œå¼¹çª— -->
    <div id="leaderboardModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border-2 border-cyan-500 rounded-3xl p-6 max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col modal-enter">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">
                    ğŸ† æ’è¡Œæ¦œ
                </h2>
                <button onclick="closeLeaderboard()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <!-- æ’è¡Œæ¦œç±»å‹åˆ‡æ¢ -->
            <div class="flex gap-2 mb-4">
                <button onclick="switchLeaderboardType('global')" class="lb-type-btn px-4 py-2 rounded-full bg-cyan-500/20 text-cyan-400 border border-cyan-500 text-sm active" data-type="global">
                    ğŸŒ å…¨çƒæ’è¡Œ
                </button>
                <button onclick="switchLeaderboardType('local')" class="lb-type-btn px-4 py-2 rounded-full bg-gray-800 text-gray-400 border border-gray-600 text-sm" data-type="local">
                    ğŸ’¾ æœ¬åœ°è®°å½•
                </button>
            </div>

            <!-- ç­›é€‰å™¨ -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button onclick="filterLeaderboard('all')" class="leaderboard-filter px-4 py-1 rounded-full bg-cyan-500/20 text-cyan-400 border border-cyan-500 text-sm active" data-filter="all">å…¨éƒ¨</button>
                <button onclick="filterLeaderboard('cet4')" class="leaderboard-filter px-4 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-600 text-sm hover:border-blue-500 hover:text-blue-400" data-filter="cet4">å››çº§</button>
                <button onclick="filterLeaderboard('cet6')" class="leaderboard-filter px-4 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-600 text-sm hover:border-purple-500 hover:text-purple-400" data-filter="cet6">å…­çº§</button>
                <button onclick="filterLeaderboard('ielts')" class="leaderboard-filter px-4 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-600 text-sm hover:border-red-500 hover:text-red-400" data-filter="ielts">é›…æ€</button>
                <button onclick="filterLeaderboard('toefl')" class="leaderboard-filter px-4 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-600 text-sm hover:border-orange-500 hover:text-orange-400" data-filter="toefl">æ‰˜ç¦</button>
                <button onclick="filterLeaderboard('programming')" class="leaderboard-filter px-4 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-600 text-sm hover:border-cyan-500 hover:text-cyan-400" data-filter="programming">ç¼–ç¨‹</button>
            </div>

            <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
            <div class="overflow-y-auto flex-1 pr-2" style="max-height: 50vh;">
                <table class="w-full text-left">
                    <thead class="text-gray-500 text-xs uppercase tracking-wider sticky top-0 bg-gray-900">
                        <tr>
                            <th class="pb-3 pl-2">æ’å</th>
                            <th class="pb-3">ç©å®¶</th>
                            <th class="pb-3">è¯ä¹¦</th>
                            <th class="pb-3 text-right">WPM</th>
                            <th class="pb-3 text-right">å‡†ç¡®ç‡</th>
                            <th class="pb-3 text-right">æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody" class="text-sm">
                        <tr>
                            <td colspan="6" class="text-center py-8 text-gray-500">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- æˆ‘çš„è®°å½• -->
            <div class="mt-4 pt-4 border-t border-gray-800">
                <div class="text-gray-400 text-xs uppercase tracking-wider mb-2">æˆ‘çš„æœ€ä½³è®°å½•</div>
                <div id="personalBest" class="text-sm text-gray-300">
                    æš‚æ— è®°å½•
                </div>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div id="historyModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border-2 border-pink-500 rounded-3xl p-6 max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col modal-enter">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-500">
                    ğŸ“Š æ‰“å­—å†å²
                </h2>
                <button onclick="closeHistory()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="stat-card rounded-xl p-4 text-center">
                    <div class="text-gray-500 text-xs uppercase mb-1">æ€»åœºæ¬¡</div>
                    <div id="totalGames" class="text-2xl font-bold text-cyan-400">0</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <div class="text-gray-500 text-xs uppercase mb-1">æœ€é«˜WPM</div>
                    <div id="bestWpm" class="text-2xl font-bold text-green-400">0</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <div class="text-gray-500 text-xs uppercase mb-1">å¹³å‡å‡†ç¡®ç‡</div>
                    <div id="avgAccuracy" class="text-2xl font-bold text-purple-400">0%</div>
                </div>
                <div class="stat-card rounded-xl p-4 text-center">
                    <div class="text-gray-500 text-xs uppercase mb-1">æ€»å•è¯æ•°</div>
                    <div id="totalWords" class="text-2xl font-bold text-yellow-400">0</div>
                </div>
            </div>

            <!-- å†å²åˆ—è¡¨ -->
            <div class="overflow-y-auto flex-1 pr-2" style="max-height: 40vh;">
                <table class="w-full text-left">
                    <thead class="text-gray-500 text-xs uppercase tracking-wider sticky top-0 bg-gray-900">
                        <tr>
                            <th class="pb-3">æ—¥æœŸ</th>
                            <th class="pb-3">è¯ä¹¦</th>
                            <th class="pb-3 text-right">WPM</th>
                            <th class="pb-3 text-right">å‡†ç¡®ç‡</th>
                            <th class="pb-3 text-right">è¯„çº§</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody" class="text-sm">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">æš‚æ— è®°å½•</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 flex gap-2">
                <button onclick="clearHistory()" class="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg border border-red-500/50 hover:bg-red-500/30 transition-all text-sm">
                    ğŸ—‘ï¸ æ¸…ç©ºå†å²
                </button>
                <button onclick="exportHistory()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg border border-green-500/50 hover:bg-green-500/30 transition-all text-sm">
                    ğŸ“¤ å¯¼å‡ºæ•°æ®
                </button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®ç”¨æˆ·åå¼¹çª— -->
    <div id="usernameModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border-2 border-purple-500 rounded-3xl p-8 max-w-md w-full modal-enter text-center">
            <div class="text-5xl mb-4">ğŸ‘¾</div>
            <h2 class="text-2xl font-bold text-white mb-2">è®¾ç½®ç©å®¶åç§°</h2>
            <p class="text-gray-400 mb-6">è¾“å…¥ä½ çš„åå­—ï¼ŒæŒ‘æˆ˜å…¨çƒæ’è¡Œæ¦œï¼</p>
            
            <input type="text" id="usernameInput" class="w-full bg-gray-800 border border-gray-600 rounded-xl px-4 py-3 text-white text-center mb-4 focus:border-cyan-500 focus:outline-none" placeholder="è¾“å…¥æ˜µç§°" maxlength="20">
            
            <button onclick="saveUsername()" class="w-full py-3 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-xl font-bold text-white hover:shadow-lg hover:shadow-cyan-500/50 transition-all">
                å¼€å§‹å†’é™©
            </button>
        </div>
    </div>

    <!-- é€šå…³å¼¹çª— -->
    <div id="victoryModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 victory-overlay">
        <div class="bg-gray-900 border-2 border-cyan-500 rounded-3xl p-8 max-w-md w-full text-center relative overflow-hidden shadow-2xl">
            <div id="starsContainer" class="absolute inset-0 pointer-events-none"></div>
            
            <div class="text-6xl mb-4 animate-bounce">ğŸ†</div>
            <h2 class="text-4xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">å…³å¡å®Œæˆ!</h2>
            <p class="text-gray-400 mb-6" id="victoryMessage">å¤ªæ£’äº†ï¼</p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="stat-card rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">æœ€ç»ˆWPM</div>
                    <div class="text-4xl font-bold text-cyan-400 font-mono" id="finalWPM">0</div>
                </div>
                <div class="stat-card rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">å‡†ç¡®ç‡</div>
                    <div class="text-4xl font-bold text-purple-400 font-mono" id="finalAcc">0%</div>
                </div>
                <div class="stat-card rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">æœ€é«˜è¿å‡»</div>
                    <div class="text-4xl font-bold text-yellow-400 font-mono" id="finalCombo">0</div>
                </div>
                <div class="stat-card rounded-xl p-4 border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">è¯„çº§</div>
                    <div class="text-4xl font-bold text-green-400" id="finalRank">S</div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="showLeaderboardFromVictory()" class="flex-1 py-3 bg-gray-800 rounded-xl border border-gray-600 hover:border-pink-500 hover:text-pink-400 transition-all font-bold">
                    ğŸ† æ’è¡Œæ¦œ
                </button>
                <button onclick="submitAndNext()" class="flex-1 py-3 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-xl font-bold text-white hover:shadow-lg hover:shadow-cyan-500/50 transition-all transform hover:scale-105 text-lg">
                    å†æ¥ä¸€å±€
                </button>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬åŠ è½½é¡ºåº -->
    <script src="js/vocabulary.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/leaderboard.js"></script>

    <script>
        // ==================== é…ç½® ====================
        let currentDifficulty = 'normal';
        let wordCount = { easy: 10, normal: 20, hard: 30, daily: 25 };
        let leaderboardType = 'global';

        // ==================== éŸ³é¢‘ç³»ç»Ÿ ====================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let soundEnabled = true;
        let musicEnabled = true;
        let musicInterval = null;
        let currentBook = 'cet4';

        // è¶…çº§é©¬é‡Œå¥¥é£æ ¼8-bitèƒŒæ™¯éŸ³ä¹
        const musicNotes = [
            { freq: 659.25, duration: 150 }, { freq: 659.25, duration: 150 }, { freq: 0, duration: 150 },
            { freq: 659.25, duration: 150 }, { freq: 0, duration: 150 }, { freq: 523.25, duration: 150 },
            { freq: 659.25, duration: 150 }, { freq: 0, duration: 150 }, { freq: 783.99, duration: 150 },
            { freq: 0, duration: 300 }, { freq: 392.00, duration: 150 }, { freq: 0, duration: 300 },
            { freq: 523.25, duration: 150 }, { freq: 0, duration: 150 }, { freq: 392.00, duration: 150 },
            { freq: 0, duration: 150 }, { freq: 329.63, duration: 150 }, { freq: 0, duration: 150 },
            { freq: 440.00, duration: 150 }, { freq: 493.88, duration: 150 }, { freq: 466.16, duration: 150 },
            { freq: 440.00, duration: 150 }, { freq: 0, duration: 150 }, { freq: 349.23, duration: 150 },
            { freq: 392.00, duration: 150 }, { freq: 0, duration: 150 }, { freq: 329.63, duration: 150 },
            { freq: 0, duration: 150 }, { freq: 293.66, duration: 150 }, { freq: 349.23, duration: 150 },
            { freq: 0, duration: 150 }, { freq: 261.63, duration: 150 },
        ];

        let musicIndex = 0;

        // åˆå§‹åŒ–éŸ³é¢‘
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(type) {
            if (!soundEnabled || !audioCtx) return;

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            switch(type) {
                case 'key':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800 + Math.random() * 100, now);
                    osc.frequency.exponentialRampToValueAtTime(400, now + 0.05);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                    break;

                case 'jump':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                    osc.frequency.linearRampToValueAtTime(120, now + 0.2);
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                    break;

                case 'coin':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(987.77, now);
                    osc.frequency.setValueAtTime(1318.51, now + 0.08);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.setValueAtTime(0.1, now + 0.08);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                    break;

                case 'error':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                    break;

                case 'powerup':
                    osc.type = 'square';
                    const notes = [523.25, 659.25, 783.99, 1046.50];
                    notes.forEach((freq, i) => {
                        osc.frequency.setValueAtTime(freq, now + i * 0.1);
                    });
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.linearRampToValueAtTime(0.01, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                    break;

                case 'victory':
                    playVictoryMusic();
                    break;
            }
        }

        // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
        function playBackgroundMusic() {
            if (!musicEnabled || !audioCtx) return;
            
            const note = musicNotes[musicIndex];
            if (note.freq > 0) {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(note.freq, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + note.duration / 1000);
                
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + note.duration / 1000);
            }
            
            musicIndex = (musicIndex + 1) % musicNotes.length;
        }

        // å¼€å§‹èƒŒæ™¯éŸ³ä¹å¾ªç¯
        function startMusic() {
            if (musicInterval) clearInterval(musicInterval);
            musicInterval = setInterval(playBackgroundMusic, 150);
        }

        // åœæ­¢èƒŒæ™¯éŸ³ä¹
        function stopMusic() {
            if (musicInterval) {
                clearInterval(musicInterval);
                musicInterval = null;
            }
        }

        // é€šå…³èƒœåˆ©éŸ³ä¹
        function playVictoryMusic() {
            if (!audioCtx) return;
            
            const victoryNotes = [
                { f: 523.25, d: 0.1 }, { f: 523.25, d: 0.1 }, { f: 523.25, d: 0.1 },
                { f: 659.25, d: 0.3 }, { f: 783.99, d: 0.1 }, { f: 783.99, d: 0.1 },
                { f: 783.99, d: 0.1 }, { f: 880.00, d: 0.3 }
            ];
            
            let time = audioCtx.currentTime;
            victoryNotes.forEach(note => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(note.f, time);
                gain.gain.setValueAtTime(0.15, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + note.d);
                
                osc.start(time);
                osc.stop(time + note.d);
                time += note.d;
            });
        }

        // ==================== æ¸¸æˆé€»è¾‘ ====================
        let words = [];
        let currentWordIndex = 0;
        let currentCharIndex = 0;
        let isPlaying = false;
        let startTime = null;
        let errorCount = 0;
        let totalChars = 0;
        let maxCombo = 0;
        let currentCombo = 0;
        let finalScoreData = null;

        // éš¾åº¦è®¾ç½®
        function setDifficulty(difficulty) {
            currentDifficulty = difficulty;
            
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active', 'scale-105');
            });
            
            const activeBtn = document.querySelector(`[data-difficulty="${difficulty}"]`);
            activeBtn.classList.add('active', 'scale-105');
            
            if (!isPlaying) {
                resetGame();
            }
        }

        // æ£€æŸ¥å¹¶æ˜¾ç¤ºç”¨æˆ·åè®¾ç½®
        function checkUsername() {
            const saved = leaderboard.getUsername();
            if (!saved || saved.startsWith('åŒ¿åç©å®¶_')) {
                document.getElementById('usernameModal').classList.remove('hidden');
                document.getElementById('usernameInput').focus();
            }
        }

        function saveUsername() {
            const input = document.getElementById('usernameInput');
            const name = input.value.trim();
            if (name) {
                leaderboard.setUsername(name);
                document.getElementById('usernameModal').classList.add('hidden');
            }
        }

        function selectBook(bookKey) {
            currentBook = bookKey;
            
            document.querySelectorAll('.book-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.boxShadow = 'none';
            });
            
            const activeBtn = document.querySelector(`[data-book="${bookKey}"]`);
            activeBtn.classList.add('active');
            
            if (!isPlaying) {
                resetGame();
            }
        }

        // ç”Ÿæˆæ¯æ—¥æŒ‘æˆ˜å•è¯
        function getDailyChallenge() {
            const today = new Date().toDateString();
            const seed = today.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            
            // åˆå¹¶æ‰€æœ‰è¯ä¹¦
            const allWords = [];
            Object.keys(vocabularyBooks).forEach(key => {
                vocabularyBooks[key].forEach(word => {
                    allWords.push({ ...word, book: key });
                });
            });
            
            // ä¼ªéšæœºé€‰æ‹©
            const selected = [];
            for (let i = 0; i < wordCount.daily; i++) {
                const index = (seed * (i + 1)) % allWords.length;
                selected.push(allWords[index]);
            }
            
            return selected;
        }

        function generateWords() {
            if (currentDifficulty === 'daily') {
                words = getDailyChallenge();
                return;
            }
            
            const book = vocabularyBooks[currentBook];
            words = [];
            const shuffled = [...book].sort(() => Math.random() - 0.5);
            const count = wordCount[currentDifficulty];
            for (let i = 0; i < count; i++) {
                words.push(shuffled[i % shuffled.length]);
            }
        }

        function renderTrack() {
            const track = document.getElementById('textTrack');
            track.innerHTML = '';
            
            words.forEach((wordObj, wordIdx) => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'word';
                wordDiv.id = `word-${wordIdx}`;
                
                const trans = document.createElement('div');
                trans.className = 'translation';
                trans.textContent = wordObj.cn;
                wordDiv.appendChild(trans);
                
                wordObj.en.split('').forEach((char, charIdx) => {
                    const charSpan = document.createElement('span');
                    charSpan.className = 'char pending text-4xl font-bold';
                    charSpan.textContent = char;
                    charSpan.id = `char-${wordIdx}-${charIdx}`;
                    
                    if (wordIdx === 0 && charIdx === 0) {
                        charSpan.classList.add('cursor', 'text-cyan-400');
                        charSpan.classList.remove('pending');
                    }
                    
                    wordDiv.appendChild(charSpan);
                });
                
                track.appendChild(wordDiv);
            });
            
            updateProgress();
        }

        function scrollToCurrent() {
            const currentWord = document.getElementById(`word-${currentWordIndex}`);
            if (!currentWord) return;
            
            const track = document.getElementById('textTrack');
            const container = track.parentElement;
            const containerWidth = container.offsetWidth;
            
            const wordOffset = currentWord.offsetLeft;
            const centerOffset = containerWidth / 2 - 150;
            
            track.style.transform = `translateX(${centerOffset - wordOffset}px)`;
            
            const transDiv = document.getElementById('currentTranslation');
            if (currentWordIndex < words.length) {
                transDiv.textContent = words[currentWordIndex].cn;
                transDiv.style.opacity = '1';
                transDiv.style.transform = 'translateY(0)';
            }
        }

        function createParticle(x, y, color) {
            for (let i = 0; i < 6; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.width = (4 + Math.random() * 4) + 'px';
                p.style.height = p.style.width;
                p.style.background = color;
                p.style.setProperty('--tx', (Math.random() - 0.5) * 80 + 'px');
                p.style.setProperty('--ty', (Math.random() - 0.5) * 80 + 'px');
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
        }

        function handleInput(e) {
            // å…¨å±€å¿«æ·é”®
            if (!isPlaying && e.target.id !== 'usernameInput') {
                if (e.key.toLowerCase() === 'r') {
                    resetGame();
                    return;
                }
                if (e.key.toLowerCase() === 'm') {
                    toggleMusic();
                    return;
                }
                if (e.key.toLowerCase() === 's') {
                    toggleSound();
                    return;
                }
                if (e.key.toLowerCase() === 'l') {
                    showLeaderboard();
                    return;
                }
            }

            if (!isPlaying) {
                if (e.code === 'Space') {
                    e.preventDefault();
                    startGame();
                }
                return;
            }

            const currentWord = words[currentWordIndex];
            const wordEl = document.getElementById(`word-${currentWordIndex}`);

            if (e.key === 'Backspace') {
                if (currentCharIndex > 0) {
                    currentCharIndex--;
                    updateChar(currentWordIndex, currentCharIndex, 'pending');
                    currentCombo = 0;
                    updateCombo();
                }
                return;
            }

            if (e.key === ' ') {
                e.preventDefault();
                if (currentCharIndex === currentWord.en.length) {
                    wordEl.classList.add('completed');
                    wordEl.classList.remove('current');
                    playSound('coin');
                    
                    currentCombo++;
                    if (currentCombo > maxCombo) maxCombo = currentCombo;
                    updateCombo();
                    
                    currentWordIndex++;
                    currentCharIndex = 0;
                    
                    if (currentWordIndex < words.length) {
                        updateChar(currentWordIndex, 0, 'current');
                        scrollToCurrent();
                    } else {
                        completeGame();
                    }
                } else {
                    wordEl.classList.add('shake');
                    setTimeout(() => wordEl.classList.remove('shake'), 200);
                    playSound('error');
                    currentCombo = 0;
                    updateCombo();
                }
                return;
            }

            if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                if (currentCharIndex >= currentWord.en.length) return;
                
                const expected = currentWord.en[currentCharIndex];
                const actual = e.key;
                const charEl = document.getElementById(`char-${currentWordIndex}-${currentCharIndex}`);
                const rect = charEl.getBoundingClientRect();
                
                if (actual === expected) {
                    playSound('key');
                    updateChar(currentWordIndex, currentCharIndex, 'correct');
                    createParticle(rect.left + rect.width/2, rect.top + rect.height/2, '#00ff88');
                    currentCharIndex++;
                    totalChars++;
                    
                    if (currentCharIndex === currentWord.en.length) {
                        wordEl.classList.add('current');
                        document.getElementById('currentTranslation').innerHTML = 
                            `<span class="text-yellow-400">æŒ‰ç©ºæ ¼ç»§ç»­ â†’</span>`;
                    }
                } else {
                    playSound('error');
                    errorCount++;
                    charEl.classList.add('wrong');
                    wordEl.classList.add('shake');
                    setTimeout(() => wordEl.classList.remove('shake'), 200);
                    createParticle(rect.left + rect.width/2, rect.top + rect.height/2, '#ff4444');
                    currentCombo = 0;
                    updateCombo();
                }
                
                updateStats();
            }
        }

        function updateChar(wordIdx, charIdx, status) {
            const charEl = document.getElementById(`char-${wordIdx}-${charIdx}`);
            if (!charEl) return;
            
            charEl.className = 'char text-4xl font-bold transition-all';
            
            switch(status) {
                case 'correct':
                    charEl.classList.add('correct');
                    break;
                case 'current':
                    charEl.classList.add('cursor', 'text-cyan-400');
                    break;
                case 'pending':
                    charEl.classList.add('pending');
                    break;
            }
            
            if (status === 'current' && charIdx > 0) {
                const prev = document.getElementById(`char-${wordIdx}-${charIdx-1}`);
                if (prev) prev.classList.remove('cursor');
            }
        }

        function updateStats() {
            const accuracy = totalChars === 0 ? 100 : Math.round(((totalChars - errorCount) / totalChars) * 100);
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            if (startTime) {
                const minutes = (Date.now() - startTime) / 60000;
                const wpm = Math.round((currentWordIndex / minutes)) || 0;
                document.getElementById('wpm').textContent = wpm;
            }
            
            updateProgress();
        }

        function updateCombo() {
            const comboEl = document.getElementById('combo');
            comboEl.textContent = currentCombo;
            if (currentCombo > 5) {
                comboEl.classList.add('text-orange-400');
                comboEl.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    comboEl.style.transform = 'scale(1)';
                }, 200);
            } else {
                comboEl.classList.remove('text-orange-400');
            }
        }

        function updateProgress() {
            const progress = (currentWordIndex / words.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `${currentWordIndex}/${words.length}`;
        }

        function startGame() {
            checkUsername();
            initAudio();
            isPlaying = true;
            startTime = Date.now();
            
            if (musicEnabled) startMusic();
            
            const overlay = document.getElementById('startOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 300);
            
            document.getElementById('inputField').focus();
            scrollToCurrent();
            playSound('powerup');
        }

        function completeGame() {
            isPlaying = false;
            stopMusic();
            playSound('victory');
            
            const minutes = (Date.now() - startTime) / 60000;
            const wpm = Math.round((words.length / minutes));
            const accuracy = Math.round(((totalChars - errorCount) / totalChars) * 100);
            
            let rank = 'C';
            let message = 'ç»§ç»­åŠ æ²¹ï¼';
            if (wpm > 100 && accuracy > 95) { rank = 'SSS'; message = 'ç¥çº§æ“ä½œï¼'; }
            else if (wpm > 80 && accuracy > 90) { rank = 'S'; message = 'å®Œç¾é€šå…³ï¼'; }
            else if (wpm > 60 && accuracy > 85) { rank = 'A'; message = 'éå¸¸å‡ºè‰²ï¼'; }
            else if (wpm > 40 && accuracy > 80) { rank = 'B'; message = 'è¡¨ç°ä¸é”™ï¼'; }
            
            finalScoreData = {
                wpm: wpm,
                accuracy: accuracy,
                book: currentBook,
                combo: maxCombo,
                rank: rank,
                difficulty: currentDifficulty,
                wordCount: words.length
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å†å²
            saveToLocalHistory(finalScoreData);
            
            document.getElementById('finalWPM').textContent = wpm;
            document.getElementById('finalAcc').textContent = accuracy + '%';
            document.getElementById('finalCombo').textContent = maxCombo;
            document.getElementById('finalRank').textContent = rank;
            document.getElementById('victoryMessage').textContent = message;
            
            const starsContainer = document.getElementById('starsContainer');
            starsContainer.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.textContent = 'â­';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    starsContainer.appendChild(star);
                }, i * 100);
            }
            
            document.getElementById('victoryModal').classList.remove('hidden');
        }

        async function submitAndNext() {
            if (finalScoreData) {
                await leaderboard.submitScore(finalScoreData);
            }
            closeVictory();
        }

        function closeVictory() {
            document.getElementById('victoryModal').classList.add('hidden');
            resetGame();
        }

        function showLeaderboardFromVictory() {
            document.getElementById('victoryModal').classList.add('hidden');
            showLeaderboard();
        }

        function resetGame() {
            isPlaying = false;
            stopMusic();
            currentWordIndex = 0;
            currentCharIndex = 0;
            errorCount = 0;
            totalChars = 0;
            currentCombo = 0;
            maxCombo = 0;
            startTime = null;
            finalScoreData = null;
            
            document.getElementById('wpm').textContent = '0';
            document.getElementById('accuracy').textContent = '100%';
            document.getElementById('combo').textContent = '0';
            document.getElementById('currentTranslation').textContent = 'å‡†å¤‡å¼€å§‹...';
            document.getElementById('currentTranslation').style.opacity = '0';
            
            const overlay = document.getElementById('startOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.opacity = '1', 10);
            
            generateWords();
            renderTrack();
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const btn = document.getElementById('musicBtn');
            const icon = document.getElementById('musicIcon');
            
            if (musicEnabled) {
                icon.textContent = 'ğŸµ';
                btn.classList.remove('opacity-50');
                if (isPlaying) startMusic();
            } else {
                icon.textContent = 'ğŸ”‡';
                btn.classList.add('opacity-50');
                stopMusic();
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundBtn');
            const icon = document.getElementById('soundIcon');
            
            if (soundEnabled) {
                icon.textContent = 'ğŸ”Š';
                btn.classList.remove('opacity-50');
            } else {
                icon.textContent = 'ğŸ”‡';
                btn.classList.add('opacity-50');
            }
        }

        // ==================== æœ¬åœ°å†å²è®°å½• ====================
        function saveToLocalHistory(scoreData) {
            const history = JSON.parse(localStorage.getItem('typequest_history') || '[]');
            history.unshift({
                ...scoreData,
                date: new Date().toLocaleDateString(),
                timestamp: Date.now()
            });
            
            // åªä¿ç•™æœ€è¿‘100æ¡
            if (history.length > 100) {
                history.splice(100);
            }
            
            localStorage.setItem('typequest_history', JSON.stringify(history));
        }

        function showHistory() {
            document.getElementById('historyModal').classList.remove('hidden');
            loadHistory();
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('typequest_history') || '[]');
            const tbody = document.getElementById('historyBody');
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">æš‚æ— è®°å½•</td></tr>';
                document.getElementById('totalGames').textContent = '0';
                document.getElementById('bestWpm').textContent = '0';
                document.getElementById('avgAccuracy').textContent = '0%';
                document.getElementById('totalWords').textContent = '0';
                return;
            }
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('totalGames').textContent = history.length;
            document.getElementById('bestWpm').textContent = Math.max(...history.map(h => h.wpm));
            const avgAcc = Math.round(history.reduce((sum, h) => sum + h.accuracy, 0) / history.length);
            document.getElementById('avgAccuracy').textContent = avgAcc + '%';
            document.getElementById('totalWords').textContent = history.reduce((sum, h) => sum + (h.wordCount || 0), 0);
            
            const bookColors = {
                cet4: 'text-blue-400',
                cet6: 'text-purple-400',
                ielts: 'text-red-400',
                toefl: 'text-orange-400',
                gre: 'text-green-400',
                programming: 'text-cyan-400',
                business: 'text-amber-400',
                academic: 'text-emerald-400'
            };
            
            const rankColors = {
                'SSS': 'text-yellow-400',
                'S': 'text-green-400',
                'A': 'text-cyan-400',
                'B': 'text-purple-400',
                'C': 'text-gray-400'
            };
            
            tbody.innerHTML = history.map(record => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="py-2 text-gray-400">${record.date}</td>
                    <td class="py-2 ${bookColors[record.book] || 'text-gray-400'}">${(record.book || 'unknown').toUpperCase()}</td>
                    <td class="py-2 text-right font-mono text-cyan-400">${record.wpm}</td>
                    <td class="py-2 text-right font-mono text-purple-400">${record.accuracy}%</td>
                    <td class="py-2 text-right font-bold ${rankColors[record.rank] || 'text-gray-400'}">${record.rank || '-'}</td>
                </tr>
            `).join('');
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('typequest_history');
                loadHistory();
            }
        }

        function exportHistory() {
            const history = JSON.parse(localStorage.getItem('typequest_history') || '[]');
            const dataStr = JSON.stringify(history, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `typequest-history-${new Date().toLocaleDateString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== æ’è¡Œæ¦œåŠŸèƒ½ ====================
        let currentFilter = 'all';

        function switchLeaderboardType(type) {
            leaderboardType = type;
            
            document.querySelectorAll('.lb-type-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-cyan-500/20', 'text-cyan-400', 'border-cyan-500');
                btn.classList.add('bg-gray-800', 'text-gray-400', 'border-gray-600');
            });
            
            const activeBtn = document.querySelector(`[data-type="${type}"]`);
            activeBtn.classList.remove('bg-gray-800', 'text-gray-400', 'border-gray-600');
            activeBtn.classList.add('bg-cyan-500/20', 'text-cyan-400', 'border-cyan-500', 'active');
            
            loadLeaderboard();
        }

        function showLeaderboard() {
            document.getElementById('leaderboardModal').classList.remove('hidden');
            loadLeaderboard();
            loadPersonalBest();
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardModal').classList.add('hidden');
        }

        function filterLeaderboard(book) {
            currentFilter = book;
            
            document.querySelectorAll('.leaderboard-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-cyan-500/20', 'text-cyan-400', 'border-cyan-500');
                btn.classList.add('bg-gray-800', 'text-gray-400', 'border-gray-600');
            });
            
            const activeBtn = document.querySelector(`[data-filter="${book}"]`);
            activeBtn.classList.remove('bg-gray-800', 'text-gray-400', 'border-gray-600');
            activeBtn.classList.add('bg-cyan-500/20', 'text-cyan-400', 'border-cyan-500', 'active');
            
            loadLeaderboard();
        }

        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">åŠ è½½ä¸­...</td></tr>';
            
            let data = [];
            
            if (leaderboardType === 'local') {
                // æœ¬åœ°æ’è¡Œæ¦œ
                const history = JSON.parse(localStorage.getItem('typequest_history') || '[]');
                const username = leaderboard.getUsername();
                
                // æŒ‰è¯ä¹¦åˆ†ç»„å–æœ€ä½³
                const bestRecords = {};
                history.forEach(record => {
                    const key = `${record.book}_${username}`;
                    if (!bestRecords[key] || record.wpm > bestRecords[key].wpm) {
                        bestRecords[key] = { ...record, username: username };
                    }
                });
                
                data = Object.values(bestRecords).sort((a, b) => b.wpm - a.wpm);
            } else {
                // å…¨çƒæ’è¡Œæ¦œ
                data = await leaderboard.getLeaderboard(currentFilter, 20);
            }
            
            // ç­›é€‰
            if (currentFilter !== 'all') {
                data = data.filter(r => r.book === currentFilter);
            }
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            const bookColors = {
                cet4: 'text-blue-400',
                cet6: 'text-purple-400',
                ielts: 'text-red-400',
                toefl: 'text-orange-400',
                gre: 'text-green-400',
                programming: 'text-cyan-400',
                business: 'text-amber-400',
                academic: 'text-emerald-400'
            };
            
            tbody.innerHTML = data.slice(0, 20).map((record, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'text-gray-400';
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1);
                
                return `
                    <tr class="leaderboard-item border-b border-gray-800">
                        <td class="py-3 pl-2 font-bold ${rankClass}">${medal}</td>
                        <td class="py-3 font-semibold text-white">${record.username || 'åŒ¿å'}</td>
                        <td class="py-3 ${bookColors[record.book] || 'text-gray-400'}">${(record.book || 'unknown').toUpperCase()}</td>
                        <td class="py-3 text-right font-mono text-cyan-400">${record.wpm}</td>
                        <td class="py-3 text-right font-mono text-purple-400">${record.accuracy}%</td>
                        <td class="py-3 text-right text-gray-500">${record.date || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadPersonalBest() {
            const username = leaderboard.getUsername();
            const div = document.getElementById('personalBest');
            
            if (!username) {
                div.textContent = 'è¯·å…ˆè®¾ç½®ç”¨æˆ·å';
                return;
            }
            
            let record = null;
            
            if (leaderboardType === 'local') {
                const history = JSON.parse(localStorage.getItem('typequest_history') || '[]');
                if (history.length > 0) {
                    if (currentFilter !== 'all') {
                        const filtered = history.filter(h => h.book === currentFilter);
                        if (filtered.length > 0) {
                            record = filtered.sort((a, b) => b.wpm - a.wpm)[0];
                        }
                    } else {
                        record = history.sort((a, b) => b.wpm - a.wpm)[0];
                    }
                }
            } else {
                record = await leaderboard.getPersonalBest(username, currentFilter);
            }
            
            if (record) {
                div.innerHTML = `
                    <span class="text-cyan-400 font-bold">${record.wpm} WPM</span>
                    <span class="text-gray-500 mx-2">|</span>
                    <span class="text-purple-400">${record.accuracy}% å‡†ç¡®ç‡</span>
                    <span class="text-gray-500 mx-2">|</span>
                    <span class="text-yellow-400">${(record.book || 'unknown').toUpperCase()}</span>
                    <span class="text-gray-500 mx-2">|</span>
                    <span class="text-green-400">${record.rank || '-'}</span>
                `;
            } else {
                div.textContent = 'æš‚æ— è®°å½•ï¼Œå¿«æ¥æŒ‘æˆ˜å§ï¼';
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', (e) => {
            if (e.target.id !== 'inputField' && e.target.id !== 'usernameInput') {
                document.getElementById('inputField').focus();
            }
            handleInput(e);
        });

        document.getElementById('startOverlay').addEventListener('click', startGame);

        document.addEventListener('click', (e) => {
            if (isPlaying && !e.target.closest('button') && !e.target.closest('#leaderboardModal') && !e.target.closest('#usernameModal') && !e.target.closest('#victoryModal') && !e.target.closest('#historyModal')) {
                document.getElementById('inputField').focus();
            }
        });

        // å›è½¦é”®ä¿å­˜ç”¨æˆ·å
        document.getElementById('usernameInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveUsername();
            }
        });

        // åˆå§‹åŒ–
        generateWords();
        renderTrack();
    </script>
</body>
</html>
